<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•™è¨€ç½‘ç«™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            color: white;
        }
        .site-title {
            text-align: center;
            flex: 1;
        }
        .site-title h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .auth-icon {
            position: relative;
            cursor: pointer;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
        }
        .auth-icon:hover {
            background: rgba(255,255,255,0.3);
        }
        .auth-dropdown {
            position: absolute;
            top: 50px;
            right: 20px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 300px;
            z-index: 1000;
            display: none;
        }
        .auth-dropdown.show {
            display: block;
        }
        .dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }
        .main-content {
            display: flex;
            gap: 30px;
            margin-top: 20px;
        }
        .message-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            flex: 1;
        }
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            margin-top: 10px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn:active {
            transform: translateY(0);
        }
        .logout-btn, .ban-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }
        .delete-btn, .pin-btn, .file-delete-btn, .file-comment-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            padding: 6px 12px;
            font-size: 14px;
            width: auto;
            margin-left: 10px;
        }
        .pin-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
        }
        .file-comment-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }
        .auth-toggle {
            text-align: center;
            margin-top: 15px;
        }
        .auth-toggle button {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            text-decoration: underline;
        }
        .messages-container {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .message-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            position: relative;
        }
        .pinned-message {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left: 4px solid #FFD700;
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            align-items: center;
        }
        .message-author {
            font-weight: 700;
            color: #333;
        }
        .message-time {
            color: #666;
            font-size: 0.9rem;
        }
        .message-content {
            color: #555;
            line-height: 1.5;
        }
        .pinned-icon {
            color: #FFD700;
            font-weight: bold;
            margin-left: 5px;
        }
        .admin-controls {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e1e5e9;
        }
        .password-change-form, .username-change-form, .user-management-form, .title-change-form, .file-upload-form {
            display: none;
        }
        .show-form-btn {
            text-align: center;
            margin-top: 15px;
        }
        .show-form-btn button {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            text-decoration: underline;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(200%);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }
        .notification.error {
            background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
        }
        .admin-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            z-index: 999;
        }
        .user-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 10px;
        }
        .user-item {
            padding: 8px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-item:last-child {
            border-bottom: none;
        }
        .user-status {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .user-status.banned {
            background: #ff6b6b;
            color: white;
        }
        .user-status.active {
            background: #4CAF50;
            color: white;
        }
        .user-info {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        .login-required {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #ff6b6b;
            font-size: 8rem;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            opacity: 0.3;
            transition: opacity 0.3s ease;
        }
        .login-required:hover {
            opacity: 0.6;
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none;
        }
        .modal-overlay.show {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin: 0 auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            color: #333;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .file-download {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            margin-left: 10px;
        }
        .file-download:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .files-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e1e5e9;
        }
        .files-title {
            text-align: center;
            margin-bottom: 15px;
            color: #333;
            font-size: 1.2rem;
        }
        .no-files {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }
        .file-comment {
            margin-top: 5px;
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
        }
        .file-comment-input {
            width: 100%;
            padding: 6px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 15px;
            }
            .site-title h1 {
                font-size: 2rem;
            }
            .auth-icon {
                margin-right: 0;
            }
            .main-content {
                flex-direction: column;
            }
            .message-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .delete-btn, .pin-btn, .file-delete-btn, .file-comment-btn {
                margin-left: 0;
                margin-top: 8px;
            }
            .login-required {
                font-size: 6rem;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-indicator" id="adminIndicator">ç®¡ç†å‘˜æ¨¡å¼</div>
    <div class="container">
        <header>
            <div class="auth-icon" id="authIcon">
                ğŸ‘¤
            </div>
            <div class="site-title">
                <h1 id="siteTitle">ğŸ“ ç•™è¨€ç½‘ç«™</h1>
                <p>æ¬¢è¿æ¥åˆ°æˆ‘ä»¬çš„ç•™è¨€å¹³å°ï¼</p>
            </div>
        </header>
        <div class="auth-dropdown" id="authDropdown">
            <div class="dropdown-header">
                <h3>ç”¨æˆ·è®¤è¯</h3>
                <button class="close-btn" id="closeAuthDropdown">&times;</button>
            </div>
            <div id="loginSection">
                <h4>ğŸ” ç™»å½•</h4>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginUsername">ç”¨æˆ·å</label>
                        <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">å¯†ç </label>
                        <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
                    </div>
                    <button type="submit" class="btn">ç™»å½•</button>
                </form>
                <div class="auth-toggle">
                    <button id="showRegisterBtn">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ</button>
                </div>
            </div>
            <div id="registerSection" style="display: none;">
                <h4>ğŸ“ æ³¨å†Œ</h4>
                <form id="registerForm">
                    <div class="form-group">
                        <label for="registerUsername">ç”¨æˆ·å</label>
                        <input type="text" id="registerUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">å¯†ç </label>
                        <input type="password" id="registerPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
                    </div>
                    <button type="submit" class="btn">æ³¨å†Œ</button>
                </form>
                <div class="auth-toggle">
                    <button id="showLoginBtn">å·²æœ‰è´¦å·ï¼Ÿç‚¹å‡»ç™»å½•</button>
                </div>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <h4>ğŸ‘¤ å½“å‰ç”¨æˆ·</h4>
                <p id="currentUsername"></p>
                <button class="btn logout-btn" id="logoutBtn">é€€å‡ºç™»å½•</button>
                <div class="admin-controls" id="adminControls" style="display: none; margin-top: 15px;">
                    <div class="show-form-btn">
                        <button id="showTitleFormBtn">ä¿®æ”¹ç½‘ç«™æ ‡é¢˜</button>
                    </div>
                    <form id="titleChangeForm" class="title-change-form">
                        <div class="form-group">
                            <label for="newSiteTitle">æ–°æ ‡é¢˜</label>
                            <input type="text" id="newSiteTitle" placeholder="è¯·è¾“å…¥æ–°æ ‡é¢˜" required>
                        </div>
                        <button type="submit" class="btn">æ›´æ–°æ ‡é¢˜</button>
                    </form>
                    <div class="show-form-btn">
                        <button id="showUsernameFormBtn">ä¿®æ”¹ç®¡ç†å‘˜ç”¨æˆ·å</button>
                    </div>
                    <form id="usernameChangeForm" class="username-change-form">
                        <div class="form-group">
                            <label for="newAdminUsername">æ–°ç”¨æˆ·å</label>
                            <input type="text" id="newAdminUsername" placeholder="è¯·è¾“å…¥æ–°ç”¨æˆ·å" required>
                        </div>
                        <button type="submit" class="btn">æ›´æ–°ç”¨æˆ·å</button>
                    </form>
                    <div class="show-form-btn">
                        <button id="showPasswordFormBtn">ä¿®æ”¹ç®¡ç†å‘˜å¯†ç </button>
                    </div>
                    <form id="passwordChangeForm" class="password-change-form">
                        <div class="form-group">
                            <label for="newPassword">æ–°å¯†ç </label>
                            <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç " required>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">ç¡®è®¤æ–°å¯†ç </label>
                            <input type="password" id="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " required>
                        </div>
                        <button type="submit" class="btn">æ›´æ–°å¯†ç </button>
                    </form>
                    <div class="show-form-btn">
                        <button id="showFileUploadBtn">æ–‡ä»¶ç®¡ç†</button>
                    </div>
                    <form id="fileUploadForm" class="file-upload-form">
                        <div class="form-group">
                            <label for="fileInput">ä¸Šä¼ æ–‡ä»¶</label>
                            <input type="file" id="fileInput" multiple>
                        </div>
                        <button type="submit" class="btn">ä¸Šä¼ æ–‡ä»¶</button>
                        <div class="user-list" id="fileList">
                            <!-- æ–‡ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </form>
                    <div class="show-form-btn">
                        <button id="showUserManagementBtn">ç”¨æˆ·ç®¡ç†</button>
                    </div>
                    <form id="userManagementForm" class="user-management-form">
                        <div class="form-group">
                            <label for="manageUser">é€‰æ‹©ç”¨æˆ·</label>
                            <select id="manageUser">
                                <!-- ç”¨æˆ·åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userAction">æ“ä½œ</label>
                            <select id="userAction">
                                <option value="ban">å°ç¦ç”¨æˆ·</option>
                                <option value="unban">è§£å°ç”¨æˆ·</option>
                                <option value="delete">åˆ é™¤ç”¨æˆ·</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">æ‰§è¡Œæ“ä½œ</button>
                        <div class="user-list" id="userList">
                            <!-- ç”¨æˆ·åˆ—è¡¨è¯¦æƒ… -->
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div class="message-section">
                <h2 class="section-title">ğŸ’¬ ç•™è¨€æ¿</h2>
                <div id="messageFormContainer">
                    <!-- ç•™è¨€è¡¨å•æˆ–ç™»å½•æç¤ºå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                <div class="messages-container" id="messagesContainer">
                    <!-- ç•™è¨€å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                <div class="files-section">
                    <h3 class="files-title">ğŸ“ ä¸Šä¼ çš„æ–‡ä»¶</h3>
                    <div id="filesContainer">
                        <!-- æ–‡ä»¶ä¸‹è½½åŒºåŸŸ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“ ç”¨æˆ·æ³¨å†Œ</h3>
                <button class="modal-close" id="closeRegisterModal">&times;</button>
            </div>
            <form id="modalRegisterForm">
                <div class="form-group">
                    <label for="modalRegisterUsername">ç”¨æˆ·å</label>
                    <input type="text" id="modalRegisterUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>
                <div class="form-group">
                    <label for="modalRegisterPassword">å¯†ç </label>
                    <input type="password" id="modalRegisterPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" class="btn">æ³¨å†Œ</button>
            </form>
        </div>
    </div>
    <div class="notification" id="notification"></div>
    <script>
        // ========== æ–°å¢ï¼šåç«¯ API åœ°å€ ==========
        const API_BASE = 'http://localhost:3000/api';

        // ========== æ›¿æ¢ localStorage ä¸º API è°ƒç”¨ ==========
        async function loadAllData() {
            try {
                const res = await fetch(`${API_BASE}/data`);
                if (!res.ok) throw new Error('åç«¯æœªå“åº”');
                return await res.json();
            } catch (err) {
                // å¦‚æœåç«¯ä¸å¯ç”¨ï¼Œå›é€€åˆ° localStorageï¼ˆä¿æŒå…¼å®¹ï¼‰
                return {
                    users: JSON.parse(localStorage.getItem('users') || '[]'),
                    messages: JSON.parse(localStorage.getItem('messages') || '[]'),
                    siteTitle: localStorage.getItem('siteTitle') || 'ğŸ“ ç•™è¨€ç½‘ç«™',
                    uploadedFiles: JSON.parse(localStorage.getItem('uploadedFiles') || '[]')
                };
            }
        }

        async function saveAllData(data) {
            try {
                await fetch(`${API_BASE}/data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } catch (err) {
                // å¦‚æœåç«¯ä¸å¯ç”¨ï¼Œå›é€€åˆ° localStorage
                localStorage.setItem('users', JSON.stringify(data.users));
                localStorage.setItem('messages', JSON.stringify(data.messages));
                localStorage.setItem('siteTitle', data.siteTitle);
                localStorage.setItem('uploadedFiles', JSON.stringify(data.uploadedFiles));
            }
        }

        // ========== åŸå§‹é€»è¾‘å‡ ä¹ä¸å˜ï¼Œä»…æ›¿æ¢æ•°æ®ä¿å­˜æ–¹å¼ ==========
        let users = [];
        let messages = [];
        let siteTitle = 'ğŸ“ ç•™è¨€ç½‘ç«™';
        let uploadedFiles = [];
        let currentUser = null;
        let isLoggedIn = false;

        // åˆå§‹åŒ–æ•°æ®
        loadAllData().then(data => {
            ({ users, messages, siteTitle, uploadedFiles } = data);
            if (users.length === 0) {
                users.push({
                    username: '1',
                    password: '1',
                    isAdmin: true,
                    isBanned: false
                });
                saveAllData({ users, messages, siteTitle, uploadedFiles });
            }
            document.getElementById('siteTitle').textContent = siteTitle;
            renderMessages();
        });

        // DOM å…ƒç´ ï¼ˆå®Œå…¨ä¸å˜ï¼‰
        const authIcon = document.getElementById('authIcon');
        const authDropdown = document.getElementById('authDropdown');
        const closeAuthDropdown = document.getElementById('closeAuthDropdown');
        const loginSection = document.getElementById('loginSection');
        const registerSection = document.getElementById('registerSection');
        const userInfo = document.getElementById('userInfo');
        const currentUsername = document.getElementById('currentUsername');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const modalRegisterForm = document.getElementById('modalRegisterForm');
        const titleChangeForm = document.getElementById('titleChangeForm');
        const usernameChangeForm = document.getElementById('usernameChangeForm');
        const passwordChangeForm = document.getElementById('passwordChangeForm');
        const fileUploadForm = document.getElementById('fileUploadForm');
        const userManagementForm = document.getElementById('userManagementForm');
        const messageFormContainer = document.getElementById('messageFormContainer');
        const messagesContainer = document.getElementById('messagesContainer');
        const adminControls = document.getElementById('adminControls');
        const logoutBtn = document.getElementById('logoutBtn');
        const showRegisterBtn = document.getElementById('showRegisterBtn');
        const showLoginBtn = document.getElementById('showLoginBtn');
        const showTitleFormBtn = document.getElementById('showTitleFormBtn');
        const showUsernameFormBtn = document.getElementById('showUsernameFormBtn');
        const showPasswordFormBtn = document.getElementById('showPasswordFormBtn');
        const showFileUploadBtn = document.getElementById('showFileUploadBtn');
        const showUserManagementBtn = document.getElementById('showUserManagementBtn');
        const notification = document.getElementById('notification');
        const adminIndicator = document.getElementById('adminIndicator');
        const manageUserSelect = document.getElementById('manageUser');
        const userList = document.getElementById('userList');
        const fileList = document.getElementById('fileList');
        const registerModal = document.getElementById('registerModal');
        const closeRegisterModal = document.getElementById('closeRegisterModal');
        const fileInput = document.getElementById('fileInput');
        const filesContainer = document.getElementById('filesContainer');

        // æ˜¾ç¤ºé€šçŸ¥ï¼ˆå®Œå…¨ä¸å˜ï¼‰
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // æ¸²æŸ“ç”¨æˆ·ç®¡ç†ï¼ˆå®Œå…¨ä¸å˜ï¼‰
        function renderUserManagement() {
            manageUserSelect.innerHTML = '';
            userList.innerHTML = '';
            users.forEach(user => {
                if (!user.isAdmin) {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = user.username;
                    manageUserSelect.appendChild(option);
                    const userDiv = document.createElement('div');
                    userDiv.className = 'user-item';
                    const statusClass = user.isBanned ? 'banned' : 'active';
                    const statusText = user.isBanned ? 'å·²å°ç¦' : 'æ­£å¸¸';
                    userDiv.innerHTML = `
                        <span>${user.username}</span>
                        <span class="user-status ${statusClass}">${statusText}</span>
                    `;
                    userList.appendChild(userDiv);
                }
            });
        }

        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨ï¼ˆå®Œå…¨ä¸å˜ï¼‰
        function renderFileList() {
            fileList.innerHTML = '';
            uploadedFiles.forEach((file, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-item';
                let deleteBtn = '';
                let commentBtn = '';
                if (isLoggedIn && currentUser && currentUser.isAdmin) {
                    deleteBtn = `<button class="btn file-delete-btn" onclick="deleteFile(${index})">åˆ é™¤</button>`;
                    commentBtn = `<button class="btn file-comment-btn" onclick="showCommentInput(${index})">æ³¨é‡Š</button>`;
                }
                let commentHTML = '';
                if (file.comment) {
                    commentHTML = `<div class="file-comment">ğŸ“ ${file.comment}</div>`;
                }
                fileDiv.innerHTML = `
                    <div style="flex:1;">
                        <span class="file-name">${file.name}</span>
                        ${commentHTML}
                        <div id="commentInput${index}" style="display:none;">
                            <input type="text" class="file-comment-input" id="commentField${index}" placeholder="è¾“å…¥æ³¨é‡Š..." value="${file.comment || ''}">
                            <button class="btn file-comment-btn" style="margin-top:5px;" onclick="saveComment(${index})">ä¿å­˜</button>
                        </div>
                    </div>
                    <div>
                        <a href="${file.data}" download="${file.name}" class="file-download">ä¸‹è½½</a>
                        ${commentBtn}
                        ${deleteBtn}
                    </div>
                `;
                fileList.appendChild(fileDiv);
            });
        }

        // æ˜¾ç¤ºæ³¨é‡Šè¾“å…¥æ¡†ï¼ˆå®Œå…¨ä¸å˜ï¼‰
        window.showCommentInput = function(index) {
            document.querySelectorAll(`[id^="commentInput"]`).forEach(el => el.style.display = 'none');
            document.getElementById(`commentInput${index}`).style.display = 'block';
        };

        // ä¿å­˜æ³¨é‡Šï¼ˆâœ… ä»…æ›¿æ¢ä¿å­˜æ–¹å¼ï¼‰
        window.saveComment = function(index) {
            const comment = document.getElementById(`commentField${index}`).value;
            uploadedFiles[index].comment = comment;
            saveAllData({ users, messages, siteTitle, uploadedFiles }); // âœ… å…³é”®ä¿®æ”¹
            renderFileList();
            renderPublicFiles();
            showNotification('æ³¨é‡Šå·²ä¿å­˜ï¼', 'success');
        };

        // æ¸²æŸ“å…¬å…±æ–‡ä»¶ï¼ˆå®Œå…¨ä¸å˜ï¼‰
        function renderPublicFiles() {
            if (uploadedFiles.length === 0) {
                filesContainer.innerHTML = '<div class="no-files">æš‚æ— ä¸Šä¼ çš„æ–‡ä»¶ï¼</div>';
                return;
            }
            let filesHTML = '';
            uploadedFiles.forEach((file, index) => {
                let commentHTML = '';
                if (file.comment) {
                    commentHTML = `<div class="file-comment">ğŸ“ ${file.comment}</div>`;
                }
                filesHTML += `
                    <div class="file-item">
                        <div style="flex:1;">
                            <span class="file-name">${file.name}</span>
                            ${commentHTML}
                        </div>
                        <a href="${file.data}" download="${file.name}" class="file-download">ä¸‹è½½</a>
                    </div>
                `;
            });
            filesContainer.innerHTML = filesHTML;
        }

        // æ¸²æŸ“ç•™è¨€ï¼ˆå®Œå…¨ä¸å˜ï¼‰
        function renderMessages() {
            messagesContainer.innerHTML = '';
            const pinnedMessages = messages.filter(msg => msg.isPinned);
            const regularMessages = messages.filter(msg => !msg.isPinned);
            pinnedMessages.forEach((msg, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-item pinned-message';
                messageDiv.dataset.index = messages.findIndex(m => m === msg);
                let adminButtons = '';
                if (isLoggedIn && currentUser && currentUser.isAdmin) {
                    adminButtons = `
                        <button class="btn delete-btn" onclick="deleteMessage(${messages.findIndex(m => m === msg)})">åˆ é™¤</button>
                        <button class="btn pin-btn" onclick="togglePin(${messages.findIndex(m => m === msg)})">å–æ¶ˆç½®é¡¶</button>
                    `;
                } else if (isLoggedIn && currentUser && msg.author === currentUser.username) {
                    adminButtons = `<button class="btn delete-btn" onclick="deleteMessage(${messages.findIndex(m => m === msg)})">åˆ é™¤</button>`;
                }
                const author = (msg.author === '1' && currentUser && currentUser.isAdmin) ? 'ç®¡ç†å‘˜' : msg.author;
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-author">${author} <span class="pinned-icon">âš¡</span></span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="message-time">${msg.timestamp}</span>
                            ${adminButtons}
                        </div>
                    </div>
                    <div class="message-content">${msg.content}</div>
                `;
                messagesContainer.appendChild(messageDiv);
            });
            regularMessages.forEach((msg, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-item';
                messageDiv.dataset.index = messages.findIndex(m => m === msg);
                let adminButtons = '';
                if (isLoggedIn && currentUser && currentUser.isAdmin) {
                    adminButtons = `
                        <button class="btn delete-btn" onclick="deleteMessage(${messages.findIndex(m => m === msg)})">åˆ é™¤</button>
                        <button class="btn pin-btn" onclick="togglePin(${messages.findIndex(m => m === msg)})">ç½®é¡¶</button>
                    `;
                } else if (isLoggedIn && currentUser && msg.author === currentUser.username) {
                    adminButtons = `<button class="btn delete-btn" onclick="deleteMessage(${messages.findIndex(m => m === msg)})">åˆ é™¤</button>`;
                }
                const author = (msg.author === '1' && currentUser && currentUser.isAdmin) ? 'ç®¡ç†å‘˜' : msg.author;
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-author">${author}</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="message-time">${msg.timestamp}</span>
                            ${adminButtons}
                        </div>
                    </div>
                    <div class="message-content">${msg.content}</div>
                `;
                messagesContainer.appendChild(messageDiv);
            });
            adminIndicator.style.display = (isLoggedIn && currentUser && currentUser.isAdmin) ? 'block' : 'none';
            if (isLoggedIn) {
                messageFormContainer.innerHTML = `
                    <form id="messageForm">
                        <div class="form-group">
                            <label for="message">ç•™è¨€å†…å®¹</label>
                            <textarea id="message" placeholder="è¯·è¾“å…¥æ‚¨çš„ç•™è¨€å†…å®¹..." required></textarea>
                        </div>
                        <button type="submit" class="btn">å‘è¡¨ç•™è¨€</button>
                    </form>
                `;
                document.getElementById('messageForm').addEventListener('submit', handleMessageSubmit);
            } else {
                messageFormContainer.innerHTML = `
                    <div class="login-required" id="loginRequired">
                        Ã—
                    </div>
                `;
                document.getElementById('loginRequired').addEventListener('click', () => {
                    showNotification('è¯·å…ˆç™»å½•ï¼', 'error');
                });
            }
            renderPublicFiles();
        }

        // å¤„ç†ç•™è¨€æäº¤ï¼ˆâœ… ä»…æ›¿æ¢ä¿å­˜æ–¹å¼ï¼‰
        function handleMessageSubmit(e) {
            e.preventDefault();
            if (!isLoggedIn || !currentUser) {
                showNotification('è¯·å…ˆç™»å½•ï¼', 'error');
                return;
            }
            if (currentUser.isBanned) {
                showNotification('æ‚¨çš„è´¦å·å·²è¢«å°ç¦ï¼Œæ— æ³•å‘è¡¨ç•™è¨€ï¼', 'error');
                return;
            }
            const message = document.getElementById('message').value;
            const timestamp = new Date().toLocaleString('zh-CN');
            const author = currentUser.isAdmin ? '1' : currentUser.username;
            messages.unshift({
                author: author,
                content: message,
                timestamp: timestamp,
                isPinned: false
            });
            saveAllData({ users, messages, siteTitle, uploadedFiles }); // âœ… å…³é”®ä¿®æ”¹
            renderMessages();
            document.getElementById('message').value = '';
            showNotification('ç•™è¨€å‘è¡¨æˆåŠŸï¼', 'success');
        }

        // åˆ é™¤ç•™è¨€ï¼ˆâœ… ä»…æ›¿æ¢ä¿å­˜æ–¹å¼ï¼‰
        window.deleteMessage = function(index) {
            if (!isLoggedIn || !currentUser) {
                showNotification('è¯·å…ˆç™»å½•ï¼', 'error');
                return;
            }
            const msg = messages[index];
            const canDelete = currentUser.isAdmin || (msg.author === currentUser.username);
            if (!canDelete) {
                showNotification('æ‚¨åªèƒ½åˆ é™¤è‡ªå·±çš„ç•™è¨€ï¼', 'error');
                return;
            }
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ')) {
                messages.splice(index, 1);
                saveAllData({ users, messages, siteTitle, uploadedFiles }); // âœ… å…³é”®ä¿®æ”¹
                renderMessages();
                showNotification('ç•™è¨€åˆ é™¤æˆåŠŸï¼', 'success');
            }
        };

        // ç½®é¡¶ç•™è¨€ï¼ˆâœ… ä»…æ›¿æ¢ä¿å­˜æ–¹å¼ï¼‰
        window.togglePin = function(index) {
            if (!isLoggedIn || !currentUser || !currentUser.isAdmin) {
                showNotification('åªæœ‰ç®¡ç†å‘˜å¯ä»¥ç½®é¡¶ç•™è¨€ï¼', 'error');
                return;
            }
            messages[index].isPinned = !messages[index].isPinned;
            saveAllData({ users, messages, siteTitle, uploadedFiles }); // âœ… å…³é”®ä¿®æ”¹
            renderMessages();
            showNotification(messages[index].isPinned ? 'ç•™è¨€å·²ç½®é¡¶ï¼' : 'å·²å–æ¶ˆç½®é¡¶ï¼', 'success');
        };

        // åˆ é™¤æ–‡ä»¶ï¼ˆâœ… ä»…æ›¿æ¢ä¿å­˜æ–¹å¼ï¼‰
        window.deleteFile = function(index) {
            if (!isLoggedIn || !currentUser || !currentUser.isAdmin) {
                showNotification('åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤æ–‡ä»¶ï¼', 'error');
                return;
            }
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                uploadedFiles.splice(index, 1);
                saveAllData({ users, messages, siteTitle, uploadedFiles }); // âœ… å…³é”®ä¿®æ”¹
                renderFileList();
                renderPublicFiles();
                showNotification('æ–‡ä»¶åˆ é™¤æˆåŠŸï¼', 'success');
            }
        };

        // ç™»å½•ã€æ³¨å†Œã€é€€å‡ºç­‰é€»è¾‘ï¼ˆå®Œå…¨ä¸å˜ï¼Œä»…æœ€åè°ƒç”¨ saveAllDataï¼‰
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                if (user.isBanned) {
                    showNotification('è¯¥è´¦å·å·²è¢«å°ç¦ï¼', 'error');
                    return;
                }
                currentUser = user;
                isLoggedIn = true;
                loginForm.reset();
                currentUsername.textContent = username;
                userInfo.style.display = 'block';
                loginSection.style.display = 'none';
                if (user.isAdmin) {
                    adminControls.style.display = 'block';
                    renderUserManagement();
                    renderFileList();
                }
                renderMessages();
                showNotification('ç™»å½•æˆåŠŸï¼', 'success');
            } else {
                showNotification('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼', 'error');
            }
        });

        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            if (users.find(u => u.username === username)) {
                showNotification('ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·åï¼', 'error');
                return;
            }
            if (username.trim() === '' || password.trim() === '') {
                showNotification('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼', 'error');
                return;
            }
            users.push({
                username: username,
                password: password,
                isAdmin: false,
                isBanned: false
            });
            saveAllData({ users, messages, siteTitle, uploadedFiles }); // âœ… å…³é”®ä¿®æ”¹
            registerForm.reset();
            showNotification('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•ã€‚', 'success');
            registerSection.style.display = 'none';
            loginSection.style.display = 'block';
        });

        modalRegisterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('modalRegisterUsername').value;
            const password = document.getElementById('modalRegisterPassword').value;
            if (users.find(u => u.username === username)) {
                showNotification('ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·åï¼', 'error');
                return;
            }
            if (username.trim() === '' || password.trim() === '') {
                showNotification('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼', 'error');
                return;
            }
            users.push({
                username: username,
                password: password,
                isAdmin: false,
                isBanned: false
            });
            saveAllData({ users, messages, siteTitle, uploadedFiles }); // âœ… å…³é”®ä¿®æ”¹
            modalRegisterForm.reset();
            registerModal.classList.remove('show');
            showNotification('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•ã€‚', 'success');
        });

        logoutBtn.addEventListener('click', () => {
            isLoggedIn = false;
            currentUser = null;
            userInfo.style.display = 'none';
            loginSection.style.display = 'block';
            adminControls.style.display = 'none';
            renderMessages();
            showNotification('å·²é€€å‡ºç™»å½•', 'success');
        });

        titleChangeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newTitle = document.getElementById('newSiteTitle').value;
            if (newTitle.trim() === '') {
                showNotification('æ ‡é¢˜ä¸èƒ½ä¸ºç©ºï¼', 'error');
                return;
            }
            siteTitle = newTitle;
            document.getElementById('siteTitle').textContent = siteTitle;
            titleChangeForm.reset();
            titleChangeForm.style.display = 'none';
            showTitleFormBtn.textContent = 'ä¿®æ”¹ç½‘ç«™æ ‡é¢˜';
            saveAllData({ users, messages, siteTitle, uploadedFiles }); // âœ… å…³é”®ä¿®æ”¹
            showNotification('ç½‘ç«™æ ‡é¢˜ä¿®æ”¹æˆåŠŸï¼', 'success');
        });

        usernameChangeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newUsername = document.getElementById('newAdminUsername').value;
            if (newUsername.trim() === '') {
                showNotification('ç”¨æˆ·åä¸èƒ½ä¸ºç©ºï¼', 'error');
                return;
            }
            if (users.find(u => u.username === newUsername && u.username !== currentUser.username)) {
                showNotification('è¯¥ç”¨æˆ·åå·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨ï¼', 'error');
                return;
            }
            currentUser.username = newUsername;
            const userIndex = users.findIndex(u => u.isAdmin);
            if (userIndex !== -1) {
                users[userIndex].username = newUsername;
            }
            currentUsername.textContent = newUsername;
            usernameChangeForm.reset();
            usernameChangeForm.style.display = 'none';
            showUsernameFormBtn.textContent = 'ä¿®æ”¹ç®¡ç†å‘˜ç”¨æˆ·å';
            saveAllData({ users, messages, siteTitle, uploadedFiles }); // âœ… å…³é”®ä¿®æ”¹
            showNotification('ç®¡ç†å‘˜ç”¨æˆ·åä¿®æ”¹æˆåŠŸï¼', 'success');
        });

        passwordChangeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (newPassword !== confirmPassword) {
                showNotification('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼', 'error');
                return;
            }
            if (newPassword.length < 1) {
                showNotification('å¯†ç ä¸èƒ½ä¸ºç©ºï¼', 'error');
                return;
            }
            currentUser.password = newPassword;
            const userIndex = users.findIndex(u => u.isAdmin);
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
            }
            passwordChangeForm.reset();
            passwordChangeForm.style.display = 'none';
            showPasswordFormBtn.textContent = 'ä¿®æ”¹ç®¡ç†å‘˜å¯†ç ';
            saveAllData({ users, messages, siteTitle, uploadedFiles }); // âœ… å…³é”®ä¿®æ”¹
            showNotification('ç®¡ç†å‘˜å¯†ç ä¿®æ”¹æˆåŠŸï¼', 'success');
        });

        fileUploadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const files = fileInput.files;
            if (files.length === 0) {
                showNotification('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼', 'error');
                return;
            }
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedFiles.push({
                        name: file.name,
                        data: e.target.result,
                        type: file.type,
                        size: file.size,
                        comment: ''
                    });
                    saveAllData({ users, messages, siteTitle, uploadedFiles }); // âœ… å…³é”®ä¿®æ”¹
                    renderFileList();
                    renderPublicFiles();
                };
                reader.readAsDataURL(file);
            });
            fileInput.value = '';
            showNotification('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼', 'success');
        });

        userManagementForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const selectedUser = document.getElementById('manageUser').value;
            const action = document.getElementById('userAction').value;
            if (!selectedUser) {
                showNotification('è¯·é€‰æ‹©è¦æ“ä½œçš„ç”¨æˆ·ï¼', 'error');
                return;
            }
            const userIndex = users.findIndex(u => u.username === selectedUser);
            if (userIndex === -1) {
                showNotification('ç”¨æˆ·ä¸å­˜åœ¨ï¼', 'error');
                return;
            }
            switch (action) {
                case 'ban':
                    users[userIndex].isBanned = true;
                    messages = messages.filter(msg => msg.author !== selectedUser);
                    break;
                case 'unban':
                    users[userIndex].isBanned = false;
                    break;
                case 'delete':
                    users.splice(userIndex, 1);
                    messages = messages.filter(msg => msg.author !== selectedUser);
                    break;
            }
            saveAllData({ users, messages, siteTitle, uploadedFiles }); // âœ… å…³é”®ä¿®æ”¹
            renderUserManagement();
            renderMessages();
            showNotification(action === 'ban' ? `ç”¨æˆ· ${selectedUser} å·²è¢«å°ç¦ï¼` : 
                          action === 'unban' ? `ç”¨æˆ· ${selectedUser} å·²è§£å°ï¼` : 
                          `ç”¨æˆ· ${selectedUser} å·²è¢«åˆ é™¤ï¼`, 'success');
        });

        // å…¶ä»–äº‹ä»¶ç›‘å¬ï¼ˆå®Œå…¨ä¸å˜ï¼‰
        showRegisterBtn.addEventListener('click', () => {
            loginSection.style.display = 'none';
            registerSection.style.display = 'block';
        });
        showLoginBtn.addEventListener('click', () => {
            registerSection.style.display = 'none';
            loginSection.style.display = 'block';
        });
        showTitleFormBtn.addEventListener('click', () => {
            titleChangeForm.style.display = titleChangeForm.style.display === 'none' ? 'block' : 'none';
            showTitleFormBtn.textContent = titleChangeForm.style.display === 'block' ? 'å–æ¶ˆä¿®æ”¹' : 'ä¿®æ”¹ç½‘ç«™æ ‡é¢˜';
        });
        showUsernameFormBtn.addEventListener('click', () => {
            usernameChangeForm.style.display = usernameChangeForm.style.display === 'none' ? 'block' : 'none';
            showUsernameFormBtn.textContent = usernameChangeForm.style.display === 'block' ? 'å–æ¶ˆä¿®æ”¹' : 'ä¿®æ”¹ç®¡ç†å‘˜ç”¨æˆ·å';
        });
        showPasswordFormBtn.addEventListener('click', () => {
            passwordChangeForm.style.display = passwordChangeForm.style.display === 'none' ? 'block' : 'none';
            showPasswordFormBtn.textContent = passwordChangeForm.style.display === 'block' ? 'å–æ¶ˆä¿®æ”¹' : 'ä¿®æ”¹ç®¡ç†å‘˜å¯†ç ';
        });
        showFileUploadBtn.addEventListener('click', () => {
            fileUploadForm.style.display = fileUploadForm.style.display === 'none' ? 'block' : 'none';
            showFileUploadBtn.textContent = fileUploadForm.style.display === 'block' ? 'å–æ¶ˆä¸Šä¼ ' : 'æ–‡ä»¶ç®¡ç†';
            if (fileUploadForm.style.display === 'block') {
                renderFileList();
            }
        });
        showUserManagementBtn.addEventListener('click', () => {
            userManagementForm.style.display = userManagementForm.style.display === 'none' ? 'block' : 'none';
            showUserManagementBtn.textContent = userManagementForm.style.display === 'block' ? 'å–æ¶ˆç®¡ç†' : 'ç”¨æˆ·ç®¡ç†';
            if (userManagementForm.style.display === 'block') {
                renderUserManagement();
            }
        });
        authIcon.addEventListener('click', () => {
            authDropdown.classList.toggle('show');
        });
        closeAuthDropdown.addEventListener('click', () => {
            authDropdown.classList.remove('show');
        });
        showRegisterBtn.addEventListener('click', (e) => {
            e.preventDefault();
            registerModal.classList.add('show');
            authDropdown.classList.remove('show');
        });
        closeRegisterModal.addEventListener('click', () => {
            registerModal.classList.remove('show');
        });
        registerModal.addEventListener('click', (e) => {
            if (e.target === registerModal) {
                registerModal.classList.remove('show');
            }
        });
        document.addEventListener('click', (e) => {
            if (!authIcon.contains(e.target) && !authDropdown.contains(e.target)) {
                authDropdown.classList.remove('show');
            }
        });

        // åˆå§‹åŒ–
        // renderMessages(); // å·²åœ¨ loadAllData.then ä¸­è°ƒç”¨
    </script>
</body>
</html>